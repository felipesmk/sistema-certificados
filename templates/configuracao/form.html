{% extends 'base.html' %}
{% block title %}Configura√ß√£o - Painel de Certificados{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-12">
    <div class="card mb-4">
      <div class="card-header">
        <h2 class="mb-0"><i class="bi bi-gear"></i> ‚öôÔ∏è Configura√ß√µes do Sistema</h2>
      </div>
      <div class="card-body">
        <form method="POST">
          
          <!-- Se√ß√£o: Autentica√ß√£o -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card">
                <div class="card-header bg-primary text-white">
                  <h5 class="mb-0"><i class="bi bi-shield-lock"></i> üîê Configura√ß√µes de Autentica√ß√£o</h5>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="auth_mode" class="form-label">
                          <i class="bi bi-person-check me-1"></i>Modo de Autentica√ß√£o
                        </label>
                        <select class="form-select" id="auth_mode" name="auth_mode" onchange="toggleLdapConfig()">
                          <option value="banco" {% if auth_mode == 'banco' %}selected{% endif %}>üè¢ Banco de Dados</option>
                          <option value="ldap" {% if auth_mode == 'ldap' %}selected{% endif %}>üè¢ LDAP/Active Directory</option>
                        </select>
                        <div class="form-text">Escolha como os usu√°rios ser√£o autenticados no sistema</div>
                      </div>
                    </div>
                                            <div class="col-md-6">
                          <div class="alert alert-info border-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Nota:</strong> O usu√°rio admin sempre pode autenticar via banco de dados, independente da configura√ß√£o.
                          </div>
                        </div>
                  </div>
                  
                  <!-- Configura√ß√µes LDAP (inicialmente ocultas) -->
                  <div id="ldap-config" class="row" style="display: none;">
                    <div class="col-12">
                      <hr>
                      <h6 class="mb-3"><i class="bi bi-server"></i> Configura√ß√µes do Servidor LDAP</h6>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="ldap_server" class="form-label">
                              <i class="bi bi-hdd-network me-1"></i>Servidor LDAP
                            </label>
                            <input type="text" class="form-control" id="ldap_server" name="ldap_server" 
                                   value="{{ ldap_config.ldap_server if ldap_config else 'ldap://seu-servidor-ldap' }}" 
                                   placeholder="ldap://servidor.empresa.com">
                            <div class="form-text">URL do servidor LDAP (ex: ldap://dc.empresa.com)</div>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="ldap_port" class="form-label">
                              <i class="bi bi-123 me-1"></i>Porta
                            </label>
                            <input type="number" class="form-control" id="ldap_port" name="ldap_port" 
                                   value="{{ ldap_config.ldap_port if ldap_config else 389 }}" 
                                   placeholder="389">
                            <div class="form-text">Porta do servidor LDAP (389 para LDAP, 636 para LDAPS)</div>
                          </div>
                        </div>
                      </div>
                      
                      <div class="row">
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="ldap_base_dn" class="form-label">
                              <i class="bi bi-diagram-3 me-1"></i>Base DN
                            </label>
                            <input type="text" class="form-control" id="ldap_base_dn" name="ldap_base_dn" 
                                   value="{{ ldap_config.ldap_base_dn if ldap_config else 'dc=empresa,dc=com,dc=br' }}" 
                                   placeholder="dc=empresa,dc=com,dc=br">
                            <div class="form-text">DN base da √°rvore LDAP</div>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="ldap_user_dn" class="form-label">
                              <i class="bi bi-people me-1"></i>User DN
                            </label>
                            <input type="text" class="form-control" id="ldap_user_dn" name="ldap_user_dn" 
                                   value="{{ ldap_config.ldap_user_dn if ldap_config else 'ou=usuarios' }}" 
                                   placeholder="ou=usuarios">
                            <div class="form-text">OU onde est√£o os usu√°rios</div>
                          </div>
                        </div>
                      </div>
                      
                      <div class="row">
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="ldap_user_attr" class="form-label">
                              <i class="bi bi-person-badge me-1"></i>Atributo do Usu√°rio
                            </label>
                            <select class="form-select" id="ldap_user_attr" name="ldap_user_attr">
                              <option value="sAMAccountName" {% if ldap_config and ldap_config.ldap_user_attr == 'sAMAccountName' %}selected{% endif %}>sAMAccountName (Windows AD)</option>
                              <option value="uid" {% if ldap_config and ldap_config.ldap_user_attr == 'uid' %}selected{% endif %}>uid (OpenLDAP)</option>
                              <option value="cn" {% if ldap_config and ldap_config.ldap_user_attr == 'cn' %}selected{% endif %}>cn (Common Name)</option>
                            </select>
                            <div class="form-text">Atributo usado para identificar o usu√°rio</div>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="ldap_bind_dn" class="form-label">
                              <i class="bi bi-person-gear me-1"></i>Bind DN (Opcional)
                            </label>
                            <input type="text" class="form-control" id="ldap_bind_dn" name="ldap_bind_dn" 
                                   value="{{ ldap_config.ldap_bind_dn if ldap_config else '' }}" 
                                   placeholder="cn=admin,dc=empresa,dc=com,dc=br">
                            <div class="form-text">DN para bind se necess√°rio (deixe vazio para bind an√¥nimo)</div>
                          </div>
                        </div>
                      </div>
                      
                      <div class="row">
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="ldap_bind_password" class="form-label">
                              <i class="bi bi-key me-1"></i>Bind Password (Opcional)
                            </label>
                            <input type="password" class="form-control" id="ldap_bind_password" name="ldap_bind_password" 
                                   value="{{ ldap_config.ldap_bind_password if ldap_config else '' }}" 
                                   placeholder="Senha do bind DN">
                            <div class="form-text">Senha do bind DN se necess√°rio</div>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="mb-3">
                            <label for="ldap_email_attr" class="form-label">
                              <i class="bi bi-envelope me-1"></i>Atributo de Email
                            </label>
                            <select class="form-select" id="ldap_email_attr" name="ldap_email_attr">
                              <option value="mail" {% if ldap_config and ldap_config.ldap_email_attr == 'mail' %}selected{% endif %}>mail</option>
                              <option value="email" {% if ldap_config and ldap_config.ldap_email_attr == 'email' %}selected{% endif %}>email</option>
                              <option value="userPrincipalName" {% if ldap_config and ldap_config.ldap_email_attr == 'userPrincipalName' %}selected{% endif %}>userPrincipalName (Windows AD)</option>
                            </select>
                            <div class="form-text">Atributo que cont√©m o email do usu√°rio</div>
                          </div>
                        </div>
                      </div>
                      
                                                                    <div class="row">
                         <div class="col-12">
                           <div class="alert alert-warning border-warning">
                             <i class="bi bi-exclamation-triangle me-2"></i>
                             <strong>Importante:</strong> Teste as configura√ß√µes LDAP antes de salvar. Configura√ß√µes incorretas podem impedir o login.
                           </div>
                         </div>
                       </div>
                       
                       <!-- Bot√£o de Teste LDAP -->
                       <div class="row mt-3">
                         <div class="col-12 text-center">
                           <button type="button" class="btn btn-outline-info btn-lg" onclick="testarLdap()">
                             <i class="bi bi-play-circle me-2"></i>Testar Conex√£o LDAP
                           </button>
                         </div>
                       </div>
                     </div>
                   </div>
                 </div>
               </div>
             </div>
           </div>

          <!-- Se√ß√£o: Configura√ß√µes de Email -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card">
                <div class="card-header bg-info text-white">
                  <h5 class="mb-0"><i class="bi bi-envelope"></i> üìß Configura√ß√µes de Email</h5>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="mail_server" class="form-label">
                          <i class="bi bi-server me-1"></i>Servidor SMTP
                        </label>
                        <input type="text" class="form-control" id="mail_server" name="mail_server" 
                               value="{{ email_config.mail_server if email_config else 'smtp.gmail.com' }}" 
                               placeholder="smtp.gmail.com">
                        <div class="form-text">Servidor SMTP para envio de emails</div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="mail_port" class="form-label">
                          <i class="bi bi-123 me-1"></i>Porta SMTP
                        </label>
                        <input type="number" class="form-control" id="mail_port" name="mail_port" 
                               value="{{ email_config.mail_port if email_config else 587 }}" 
                               placeholder="587">
                        <div class="form-text">Porta do servidor SMTP (587 para TLS, 465 para SSL)</div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="mail_username" class="form-label">
                          <i class="bi bi-person me-1"></i>Usu√°rio/Email
                        </label>
                        <input type="email" class="form-control" id="mail_username" name="mail_username" 
                               value="{{ email_config.mail_username if email_config else '' }}" 
                               placeholder="seu-email@gmail.com">
                        <div class="form-text">Email ou usu√°rio para autentica√ß√£o SMTP</div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="mail_password" class="form-label">
                          <i class="bi bi-key me-1"></i>Senha/Aplica√ß√£o
                        </label>
                        <input type="password" class="form-control" id="mail_password" name="mail_password" 
                               value="{{ email_config.mail_password if email_config else '' }}" 
                               placeholder="Senha ou senha de aplica√ß√£o">
                        <div class="form-text">Senha ou senha de aplica√ß√£o para SMTP</div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="mail_use_tls" class="form-label">
                          <i class="bi bi-shield-check me-1"></i>Seguran√ßa
                        </label>
                        <select class="form-select" id="mail_use_tls" name="mail_use_tls">
                          <option value="tls" {% if email_config and email_config.mail_use_tls == 'tls' %}selected{% endif %}>TLS (Recomendado)</option>
                          <option value="ssl" {% if email_config and email_config.mail_use_tls == 'ssl' %}selected{% endif %}>SSL</option>
                          <option value="none" {% if email_config and email_config.mail_use_tls == 'none' %}selected{% endif %}>Sem criptografia</option>
                        </select>
                        <div class="form-text">Tipo de criptografia para conex√£o SMTP</div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="mail_default_sender" class="form-label">
                          <i class="bi bi-person-badge me-1"></i>Remetente Padr√£o
                        </label>
                        <input type="email" class="form-control" id="mail_default_sender" name="mail_default_sender" 
                               value="{{ email_config.mail_default_sender if email_config else '' }}" 
                               placeholder="sistema@empresa.com">
                        <div class="form-text">Email que aparecer√° como remetente</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Configura√ß√µes pr√©-definidas -->
                  <div class="row">
                    <div class="col-12">
                      <div class="alert alert-info border-info">
                        <h6><i class="bi bi-info-circle me-2"></i>Configura√ß√µes Pr√©-definidas</h6>
                        <div class="row">
                          <div class="col-md-3">
                            <button type="button" class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="setGmailConfig()">
                              <i class="bi bi-google me-1"></i>Gmail
                            </button>
                          </div>
                          <div class="col-md-3">
                            <button type="button" class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="setOutlookConfig()">
                              <i class="bi bi-microsoft me-1"></i>Outlook
                            </button>
                          </div>
                          <div class="col-md-3">
                            <button type="button" class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="setOffice365Config()">
                              <i class="bi bi-building me-1"></i>Office 365
                            </button>
                          </div>
                          <div class="col-md-3">
                            <button type="button" class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="setExchangeConfig()">
                              <i class="bi bi-server me-1"></i>Exchange
                            </button>
                          </div>
                          <div class="col-md-3">
                            <button type="button" class="btn btn-outline-success btn-sm w-100 mb-2" onclick="setSMTP4DevConfig()">
                              <i class="bi bi-tools me-1"></i>SMTP4Dev
                            </button>
                          </div>
                        </div>
                        <small class="text-muted">
                          <strong>Nota:</strong> Para Gmail, use senha de aplica√ß√£o. Para Office 365, pode ser necess√°rio configurar autentica√ß√£o moderna.
                        </small>
                        
                        <!-- Informa√ß√µes SMTP4Dev -->
                        <div class="alert alert-success border-success mt-3">
                          <h6><i class="bi bi-info-circle me-2"></i>Teste Local com SMTP4Dev</h6>
                          <p class="mb-2">
                            Para testar emails localmente sem enviar emails reais, use o <strong>SMTP4Dev</strong>:
                          </p>
                          <ul class="mb-2">
                            <li><strong>Download:</strong> <a href="https://github.com/rnwood/smtp4dev/releases" target="_blank">GitHub SMTP4Dev</a></li>
                            <li><strong>Porta padr√£o:</strong> 3000</li>
                            <li><strong>Interface web:</strong> http://localhost:3000</li>
                            <li><strong>Sem autentica√ß√£o:</strong> Deixe usu√°rio e senha vazios</li>
                          </ul>
                          <small class="text-muted">
                            Clique no bot√£o "SMTP4Dev" acima para aplicar as configura√ß√µes automaticamente.
                          </small>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Bot√£o de Teste Email -->
                  <div class="row">
                    <div class="col-12 text-center">
                      <button type="button" class="btn btn-outline-info btn-lg" onclick="testarEmail()">
                        <i class="bi bi-envelope-paper me-2"></i>Testar Configura√ß√£o de Email
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Se√ß√£o: Agendamento de Alertas -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card">
                <div class="card-header bg-warning text-dark">
                  <h5 class="mb-0"><i class="bi bi-clock"></i> ‚è∞ Configura√ß√µes de Agendamento</h5>
                </div>
                                 <div class="card-body">
                   <!-- Toggle de Ativa√ß√£o -->
                   <div class="row mb-3">
                     <div class="col-12">
                       <div class="form-check form-switch">
                         <input class="form-check-input" type="checkbox" id="agendamento_ativo" name="agendamento_ativo" 
                                {% if config and config.agendamento_ativo %}checked{% endif %} 
                                onchange="toggleAgendamento()">
                         <label class="form-check-label" for="agendamento_ativo">
                           <i class="bi bi-toggle-on me-2"></i><strong>Agendamento Autom√°tico Ativo</strong>
                         </label>
                       </div>
                       <div class="form-text">
                         <i class="bi bi-info-circle me-1"></i>
                         Quando ativado, os alertas ser√£o enviados automaticamente conforme o agendamento. 
                         O envio manual continua funcionando independente desta configura√ß√£o.
                       </div>
                     </div>
                   </div>
                   
                   <div class="row" id="config-agendamento">
                     <div class="col-md-4">
                       <div class="mb-3">
                         <label for="dia_semana" class="form-label">
                           <i class="bi bi-calendar-week me-1"></i>Dia da Semana
                         </label>
                         <select class="form-select" id="dia_semana" name="dia_semana">
                           <option value="mon" {% if config and config.dia_semana == 'mon' %}selected{% endif %}>üìÖ Segunda-feira</option>
                           <option value="tue" {% if config and config.dia_semana == 'tue' %}selected{% endif %}>üìÖ Ter√ßa-feira</option>
                           <option value="wed" {% if config and config.dia_semana == 'wed' %}selected{% endif %}>üìÖ Quarta-feira</option>
                           <option value="thu" {% if config and config.dia_semana == 'thu' %}selected{% endif %}>üìÖ Quinta-feira</option>
                           <option value="fri" {% if config and config.dia_semana == 'fri' %}selected{% endif %}>üìÖ Sexta-feira</option>
                           <option value="sat" {% if config and config.dia_semana == 'sat' %}selected{% endif %}>üìÖ S√°bado</option>
                           <option value="sun" {% if config and config.dia_semana == 'sun' %}selected{% endif %}>üìÖ Domingo</option>
                         </select>
                         <div class="form-text">Dia da semana para envio dos alertas</div>
                       </div>
                     </div>
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label for="hora" class="form-label">
                          <i class="bi bi-hourglass-split me-1"></i>Hora
                        </label>
                                                   <input type="number" class="form-control" id="hora" name="hora" 
                                  value="{{ config.hora if config else 14 }}" min="0" max="23">
                        <div class="form-text">Hora do dia para envio (0-23)</div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label for="minuto" class="form-label">
                          <i class="bi bi-clock-history me-1"></i>Minuto
                        </label>
                                                   <input type="number" class="form-control" id="minuto" name="minuto" 
                                  value="{{ config.minuto if config else 0 }}" min="0" max="59">
                        <div class="form-text">Minuto da hora para envio (0-59)</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Bot√µes de A√ß√£o -->
          <div class="row">
            <div class="col-12 text-center">
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-check-circle me-2"></i>Salvar Configura√ß√µes
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
/* Melhorias para modo escuro */
@media (prefers-color-scheme: dark) {
  .card {
    background-color: var(--bs-dark);
    border-color: var(--bs-gray-600);
  }
  
  .card-body {
    background-color: var(--bs-dark);
  }
  
  .alert-info {
    background-color: rgba(13, 202, 240, 0.1);
    border-color: var(--bs-info);
    color: var(--bs-info);
  }
  
  .alert-warning {
    background-color: rgba(255, 193, 7, 0.1);
    border-color: var(--bs-warning);
    color: var(--bs-warning);
  }
  
  .form-text {
    color: var(--bs-gray-400);
  }
  
  .form-label {
    color: var(--bs-light);
  }
  
  .form-control, .form-select {
    background-color: var(--bs-dark);
    border-color: var(--bs-gray-600);
    color: var(--bs-light);
  }
  
  .form-control:focus, .form-select:focus {
    background-color: var(--bs-dark);
    border-color: var(--bs-primary);
    color: var(--bs-light);
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
  }
  
  .form-control::placeholder {
    color: var(--bs-gray-500);
  }
}

/* Melhorias gerais */
.card {
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  border: 1px solid rgba(0, 0, 0, 0.125);
}

.card-header {
  border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

.alert {
  border-radius: 0.375rem;
  border-width: 1px;
  border-style: solid;
}
</style>

<script>
function toggleLdapConfig() {
  const authMode = document.getElementById('auth_mode').value;
  const ldapConfig = document.getElementById('ldap-config');
  
  if (authMode === 'ldap') {
    ldapConfig.style.display = 'block';
  } else {
    ldapConfig.style.display = 'none';
  }
}

function testarLdap() {
  const authMode = document.getElementById('auth_mode').value;
  
  if (authMode !== 'ldap') {
    alert('Selecione o modo LDAP primeiro!');
    return;
  }
  
  // Pegar valores do formul√°rio
  const formData = new FormData();
  formData.append('ldap_server', document.getElementById('ldap_server').value);
  formData.append('ldap_port', document.getElementById('ldap_port').value);
  formData.append('ldap_base_dn', document.getElementById('ldap_base_dn').value);
  formData.append('ldap_user_dn', document.getElementById('ldap_user_dn').value);
  formData.append('ldap_user_attr', document.getElementById('ldap_user_attr').value);
  formData.append('ldap_bind_dn', document.getElementById('ldap_bind_dn').value);
  formData.append('ldap_bind_password', document.getElementById('ldap_bind_password').value);
  
  // Mostrar loading
  const btn = event.target;
  const originalText = btn.innerHTML;
  btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Testando...';
  btn.disabled = true;
  
  // Fazer requisi√ß√£o AJAX
  fetch('/testar-ldap', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(`‚úÖ ${data.message}`);
    } else {
      alert(`‚ùå ${data.message}`);
    }
  })
  .catch(error => {
    alert(`‚ùå Erro ao testar conex√£o: ${error.message}`);
  })
  .finally(() => {
    btn.innerHTML = originalText;
    btn.disabled = false;
  });
}

function toggleAgendamento() {
  const agendamentoAtivo = document.getElementById('agendamento_ativo').checked;
  const configAgendamento = document.getElementById('config-agendamento');
  const campos = configAgendamento.querySelectorAll('input, select');
  
  if (agendamentoAtivo) {
    configAgendamento.style.opacity = '1';
    campos.forEach(campo => {
      campo.disabled = false;
    });
  } else {
    configAgendamento.style.opacity = '0.5';
    campos.forEach(campo => {
      campo.disabled = true;
    });
  }
}

// Fun√ß√µes para configura√ß√µes pr√©-definidas de email
function setGmailConfig() {
  document.getElementById('mail_server').value = 'smtp.gmail.com';
  document.getElementById('mail_port').value = '587';
  document.getElementById('mail_use_tls').value = 'tls';
  alert('Configura√ß√£o Gmail aplicada! Lembre-se de usar senha de aplica√ß√£o.');
}

function setOutlookConfig() {
  document.getElementById('mail_server').value = 'smtp-mail.outlook.com';
  document.getElementById('mail_port').value = '587';
  document.getElementById('mail_use_tls').value = 'tls';
  alert('Configura√ß√£o Outlook aplicada!');
}

function setOffice365Config() {
  document.getElementById('mail_server').value = 'smtp.office365.com';
  document.getElementById('mail_port').value = '587';
  document.getElementById('mail_use_tls').value = 'tls';
  alert('Configura√ß√£o Office 365 aplicada!');
}

function setExchangeConfig() {
  document.getElementById('mail_server').value = 'smtp.office365.com';
  document.getElementById('mail_port').value = '587';
  document.getElementById('mail_use_tls').value = 'tls';
  alert('Configura√ß√£o Exchange aplicada! Use o mesmo servidor do Office 365.');
}

function setSMTP4DevConfig() {
  document.getElementById('mail_server').value = 'localhost';
  document.getElementById('mail_port').value = '3000';
  document.getElementById('mail_use_tls').value = 'none';
  document.getElementById('mail_username').value = '';
  document.getElementById('mail_password').value = '';
  document.getElementById('mail_default_sender').value = 'teste@sistema.com';
  alert('Configura√ß√£o SMTP4Dev aplicada! Certifique-se de que o SMTP4Dev est√° rodando na porta 3000.');
}

function testarEmail() {
  const mailServer = document.getElementById('mail_server').value;
  const mailPort = document.getElementById('mail_port').value;
  const mailUsername = document.getElementById('mail_username').value;
  const mailPassword = document.getElementById('mail_password').value;
  const mailUseTls = document.getElementById('mail_use_tls').value;
  const mailDefaultSender = document.getElementById('mail_default_sender').value;
  
  if (!mailServer || !mailPort || !mailUsername || !mailPassword) {
    alert('Preencha todos os campos obrigat√≥rios de email!');
    return;
  }
  
  // Mostrar loading
  const btn = event.target;
  const originalText = btn.innerHTML;
  btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Testando...';
  btn.disabled = true;
  
  // Preparar dados
  const formData = new FormData();
  formData.append('mail_server', mailServer);
  formData.append('mail_port', mailPort);
  formData.append('mail_username', mailUsername);
  formData.append('mail_password', mailPassword);
  formData.append('mail_use_tls', mailUseTls);
  formData.append('mail_default_sender', mailDefaultSender);
  
  // Fazer requisi√ß√£o AJAX
  fetch('/testar-email', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(`‚úÖ ${data.message}`);
    } else {
      alert(`‚ùå ${data.message}`);
    }
  })
  .catch(error => {
    alert(`‚ùå Erro ao testar email: ${error.message}`);
  })
  .finally(() => {
    btn.innerHTML = originalText;
    btn.disabled = false;
  });
}

// Inicializar estado do formul√°rio
document.addEventListener('DOMContentLoaded', function() {
  toggleLdapConfig();
  toggleAgendamento();
});
</script>
{% endblock %} 