{% extends 'base.html' %}
{% block title %}Dashboard de Vencimentos - Painel de Certificados{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-12">
    <div class="card mb-4">
      <div class="card-header">
        <h2 class="mb-0"><i class="bi bi-calendar-exclamation"></i> Dashboard de Vencimentos</h2>
      </div>
      <div class="card-body">
        <!-- Cards de Resumo -->
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card text-white bg-danger mb-3">
              <div class="card-body">
                <div class="d-flex justify-content-between">
                  <div>
                    <h4 class="card-title">{{ proximos_7_dias|length }}</h4>
                    <p class="card-text">Próximos 7 dias</p>
                  </div>
                  <div class="align-self-center">
                    <i class="bi bi-exclamation-triangle fs-1"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-white bg-warning mb-3">
              <div class="card-body">
                <div class="d-flex justify-content-between">
                  <div>
                    <h4 class="card-title">{{ proximos_30_dias|length }}</h4>
                    <p class="card-text">Próximos 30 dias</p>
                  </div>
                  <div class="align-self-center">
                    <i class="bi bi-calendar-check fs-1"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-white bg-dark mb-3">
              <div class="card-body">
                <div class="d-flex justify-content-between">
                  <div>
                    <h4 class="card-title">{{ vencidos_30_dias|length }}</h4>
                    <p class="card-text">Vencidos há +30 dias</p>
                  </div>
                  <div class="align-self-center">
                    <i class="bi bi-calendar-x fs-1"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Gráfico Temporal -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Vencimentos por Período (Últimos 90 dias + Próximos 30 dias)</h5>
              </div>
              <div class="card-body">
                <canvas id="temporalChart" width="400" height="200"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Tabelas de Itens -->
        <div class="row">
          <!-- Próximos 7 dias -->
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Próximos 7 dias (Crítico)</h5>
              </div>
              <div class="card-body">
                {% if proximos_7_dias %}
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Nome</th>
                          <th>Tipo</th>
                          <th>Vencimento</th>
                          <th>Dias</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for registro in proximos_7_dias %}
                        <tr>
                          <td>{{ registro.nome }}</td>
                          <td><span class="badge bg-primary">{{ registro.tipo }}</span></td>
                          <td>{{ registro.data_vencimento.strftime('%d/%m/%Y') }}</td>
                          <td>
                            {% set dias = (registro.data_vencimento - hoje).days %}
                            <span class="badge bg-danger">{{ dias }} dias</span>
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% else %}
                  <p class="text-muted">Nenhum item vencendo nos próximos 7 dias.</p>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Próximos 30 dias -->
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-calendar-check"></i> Próximos 30 dias (Atenção)</h5>
              </div>
              <div class="card-body">
                {% if proximos_30_dias %}
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Nome</th>
                          <th>Tipo</th>
                          <th>Vencimento</th>
                          <th>Dias</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for registro in proximos_30_dias %}
                        <tr>
                          <td>{{ registro.nome }}</td>
                          <td><span class="badge bg-primary">{{ registro.tipo }}</span></td>
                          <td>{{ registro.data_vencimento.strftime('%d/%m/%Y') }}</td>
                          <td>
                            {% set dias = (registro.data_vencimento - hoje).days %}
                            <span class="badge bg-warning text-dark">{{ dias }} dias</span>
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% else %}
                  <p class="text-muted">Nenhum item vencendo nos próximos 30 dias.</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Vencidos há mais de 30 dias -->
        <div class="row mt-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-calendar-x"></i> Vencidos há mais de 30 dias (Urgente)</h5>
              </div>
              <div class="card-body">
                {% if vencidos_30_dias %}
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Nome</th>
                          <th>Tipo</th>
                          <th>Vencimento</th>
                          <th>Dias Vencido</th>
                          <th>Responsáveis</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for registro in vencidos_30_dias %}
                        <tr>
                          <td>{{ registro.nome }}</td>
                          <td><span class="badge bg-primary">{{ registro.tipo }}</span></td>
                          <td>{{ registro.data_vencimento.strftime('%d/%m/%Y') }}</td>
                          <td>
                            {% set dias = (hoje - registro.data_vencimento).days %}
                            <span class="badge bg-dark">{{ dias }} dias</span>
                          </td>
                          <td>
                            {% for responsavel in registro.responsaveis %}
                              <span class="badge bg-secondary">{{ responsavel.nome }}</span>
                            {% endfor %}
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% else %}
                  <p class="text-muted">Nenhum item vencido há mais de 30 dias.</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dados para o gráfico temporal
const temporalData = {
  labels: {{ datas_grafico|tojson }},
  datasets: [{
    label: 'Vencimentos',
    data: {{ vencimentos_grafico|tojson }},
    borderColor: '#dc3545',
    backgroundColor: 'rgba(220, 53, 69, 0.1)',
    borderWidth: 2,
    fill: true,
    tension: 0.1
  }]
};

// Configuração do gráfico temporal
const temporalConfig = {
  type: 'line',
  data: temporalData,
  options: {
    responsive: true,
    plugins: {
      legend: {
        display: false
      },
      tooltip: {
        callbacks: {
          title: function(context) {
            return 'Data: ' + context[0].label;
          },
          label: function(context) {
            return 'Vencimentos: ' + context.parsed.y;
          }
        }
      }
    },
    scales: {
      x: {
        title: {
          display: true,
          text: 'Data'
        }
      },
      y: {
        beginAtZero: true,
        title: {
          display: true,
          text: 'Quantidade de Vencimentos'
        },
        ticks: {
          stepSize: 1
        }
      }
    }
  }
};

// Criar o gráfico temporal
document.addEventListener('DOMContentLoaded', function() {
  new Chart(document.getElementById('temporalChart'), temporalConfig);
});
</script>
{% endblock %} 