{% extends 'base.html' %}

{% block title %}{% if usuario %}Editar Usuário{% else %}Novo Usuário{% endif %}{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-8 mx-auto">
    <div class="card">
      <div class="card-header">
        <h4>
          <i class="bi bi-person-gear"></i>
          {% if usuario %}Editar Usuário: {{ usuario.username }}{% else %}Novo Usuário{% endif %}
        </h4>
      </div>
      <div class="card-body">
        
        <form method="post" id="usuarioForm" novalidate>
          <!-- Campos obrigatórios -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="username" class="form-label">
                <i class="bi bi-person"></i> Nome de Usuário <span class="text-danger">*</span>
              </label>
              <input type="text" 
                     class="form-control" 
                     id="username" 
                     name="username" 
                     required 
                     minlength="3" maxlength="80"
                     value="{{ form_data.username if form_data else (usuario.username if usuario else '') }}"
                     {% if usuario and usuario.username == 'admin' %}readonly{% endif %}
                     placeholder="usuario123">
              <div class="form-text">Mínimo 3 caracteres, sem espaços</div>
              <div class="invalid-feedback"></div>
            </div>
            <div class="col-md-6">
              <label for="email" class="form-label">
                <i class="bi bi-envelope"></i> E-mail <span class="text-danger">*</span>
              </label>
              <input type="email" 
                     class="form-control" 
                     id="email" 
                     name="email" 
                     required 
                     maxlength="120"
                     value="{{ form_data.email if form_data else (usuario.email if usuario else '') }}"
                     placeholder="usuario@empresa.com">
              <div class="invalid-feedback"></div>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-12">
              <label for="nome" class="form-label">
                <i class="bi bi-person-badge"></i> Nome Completo <span class="text-danger">*</span>
              </label>
              <input type="text" 
                     class="form-control" 
                     id="nome" 
                     name="nome" 
                     required 
                     minlength="2" maxlength="120"
                     value="{{ form_data.nome if form_data else (usuario.nome if usuario else '') }}"
                     placeholder="Nome Completo">
              <div class="invalid-feedback"></div>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="password" class="form-label">
                <i class="bi bi-key"></i> Senha 
                {% if not usuario %}<span class="text-danger">*</span>{% endif %}
              </label>
              <input type="password" 
                     class="form-control" 
                     id="password" 
                     name="password" 
                     {% if not usuario %}required{% endif %}
                     minlength="6" maxlength="200"
                     placeholder="{% if usuario %}Deixe em branco para não alterar{% else %}Digite a senha{% endif %}">
              <div class="invalid-feedback"></div>
              <div class="form-text">
                {% if usuario %}
                  Deixe em branco para não alterar. Mínimo 6 caracteres.
                {% else %}
                  Mínimo 6 caracteres
                {% endif %}
              </div>
            </div>
            <div class="col-md-6">
              <label for="status" class="form-label">
                <i class="bi bi-toggle-on"></i> Status <span class="text-danger">*</span>
              </label>
              <select class="form-select" id="status" name="status" required>
                <option value="ativo" {% if (form_data.status if form_data else (usuario.status if usuario else 'ativo')) == 'ativo' %}selected{% endif %}>Ativo</option>
                <option value="inativo" {% if (form_data.status if form_data else (usuario.status if usuario else '')) == 'inativo' %}selected{% endif %}>Inativo</option>
                <option value="bloqueado" {% if (form_data.status if form_data else (usuario.status if usuario else '')) == 'bloqueado' %}selected{% endif %}>Bloqueado</option>
              </select>
            </div>
          </div>

          <!-- Perfil -->
          {% if roles and (not usuario or usuario.username != 'admin') %}
          <div class="row mb-3">
            <div class="col-md-12">
              <label for="role_id" class="form-label">
                <i class="bi bi-person-badge"></i> Perfil <span class="text-danger">*</span>
              </label>
              <select class="form-select" id="role_id" name="role_id" required>
                <option value="">Selecione um perfil...</option>
                <div class="invalid-feedback"></div>
                {% for role in roles %}
                  <option value="{{ role.id }}" 
                          {% if (form_data.role_id if form_data else (usuario.role_id if usuario else '')) == role.id|string %}selected{% endif %}
                          data-color="{{ role.cor or '#6c757d' }}">
                    {{ role.nome }}
                    {% if role.descricao %} - {{ role.descricao }}{% endif %}
                  </option>
                {% endfor %}
              </select>
            </div>
          </div>
          {% elif usuario and usuario.username == 'admin' %}
          <div class="alert alert-warning">
            <i class="bi bi-shield-exclamation"></i>
            <strong>Usuário Admin:</strong> O perfil do usuário admin não pode ser alterado.
          </div>
          {% endif %}

          <!-- Campos adicionais -->
          <h6 class="border-bottom pb-2 mb-3">
            <i class="bi bi-info-circle"></i> Informações Adicionais
          </h6>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="telefone" class="form-label">
                <i class="bi bi-telephone"></i> Telefone
              </label>
              <input type="tel" 
                     class="form-control" 
                     id="telefone" 
                     name="telefone" 
                     value="{{ form_data.telefone if form_data else (usuario.telefone if usuario else '') }}"
                     placeholder="(11) 99999-9999"
                     maxlength="20">
              <div class="form-text">Formato: (11) 99999-9999</div>
              <div class="invalid-feedback"></div>
            </div>
            <div class="col-md-6">
              <label for="departamento" class="form-label">
                <i class="bi bi-building"></i> Departamento
              </label>
              <input type="text" 
                     class="form-control" 
                     id="departamento" 
                     name="departamento" 
                     value="{{ form_data.departamento if form_data else (usuario.departamento if usuario else '') }}"
                     placeholder="Ex: TI, RH, Financeiro">
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-12">
              <label for="cargo" class="form-label">
                <i class="bi bi-briefcase"></i> Cargo
              </label>
              <input type="text" 
                     class="form-control" 
                     id="cargo" 
                     name="cargo" 
                     value="{{ form_data.cargo if form_data else (usuario.cargo if usuario else '') }}"
                     placeholder="Ex: Analista, Gerente, Coordenador">
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-12">
              <label for="observacoes" class="form-label">
                <i class="bi bi-journal-text"></i> Observações
              </label>
              <textarea class="form-control" 
                        id="observacoes" 
                        name="observacoes" 
                        rows="3" 
                        placeholder="Informações adicionais sobre o usuário...">{{ form_data.observacoes if form_data else (usuario.observacoes if usuario else '') }}</textarea>
            </div>
          </div>

          {% if usuario %}
          <!-- Informações do sistema -->
          <h6 class="border-bottom pb-2 mb-3">
            <i class="bi bi-gear"></i> Informações do Sistema
          </h6>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Criado em:</label>
              <p class="form-control-plaintext">
                {% if usuario.created_at %}
                  {{ usuario.created_at.strftime('%d/%m/%Y às %H:%M') }}
                {% else %}
                  Não informado
                {% endif %}
              </p>
            </div>
            <div class="col-md-6">
              <label class="form-label">Último Login:</label>
              <p class="form-control-plaintext">
                {% if usuario.last_login %}
                  {{ usuario.last_login.strftime('%d/%m/%Y às %H:%M') }}
                {% else %}
                  Nunca logou
                {% endif %}
              </p>
            </div>
          </div>

          {% if usuario.ldap_user %}
          <div class="alert alert-info">
            <i class="bi bi-server"></i>
            <strong>Usuário LDAP:</strong> Este usuário é sincronizado com o Active Directory.
          </div>
          {% endif %}
          {% endif %}

          <!-- Botões -->
          <div class="row mt-4">
            <div class="col-md-12">
              <button type="submit" class="btn btn-primary" id="submitBtn">
                <i class="bi bi-check-circle"></i> 
                {% if usuario %}Atualizar{% else %}Criar{% endif %} Usuário
              </button>
              <a href="{{ url_for('listar_usuarios') }}" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> Cancelar
              </a>
              {% if usuario %}
                <a href="{{ url_for('historico_usuario', usuario_id=usuario.id) }}" class="btn btn-info">
                  <i class="bi bi-clock-history"></i> Ver Histórico
                </a>
              {% endif %}
            </div>
          </div>

        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('usuarioForm');
    const submitBtn = document.getElementById('submitBtn');
    
    // Função para validar email
    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }
    
    // Função para validar username
    function isValidUsername(username) {
        const usernameRegex = /^[a-zA-Z0-9._-]+$/;
        return username.length >= 3 && usernameRegex.test(username);
    }
    
    // Máscara para telefone
    const telefoneInput = document.getElementById('telefone');
    telefoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 11) {
            value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        } else if (value.length >= 7) {
            value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
        } else if (value.length >= 3) {
            value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
        }
        e.target.value = value;
    });
    
    // Validação em tempo real
    const usernameInput = document.getElementById('username');
    const emailInput = document.getElementById('email');
    const nomeInput = document.getElementById('nome');
    const passwordInput = document.getElementById('password');
    const roleSelect = document.getElementById('role_id');
    
    // Validar username
    usernameInput.addEventListener('blur', function() {
        const username = this.value.trim();
        if (!username) {
            this.classList.add('is-invalid');
            this.nextElementSibling.nextElementSibling.textContent = 'Nome de usuário é obrigatório';
        } else if (!isValidUsername(username)) {
            this.classList.add('is-invalid');
            this.nextElementSibling.nextElementSibling.textContent = 'Nome de usuário deve ter pelo menos 3 caracteres e conter apenas letras, números, pontos, hífens e underscores';
        } else {
            this.classList.remove('is-invalid');
            this.nextElementSibling.nextElementSibling.textContent = '';
        }
    });
    
    // Validar email
    emailInput.addEventListener('blur', function() {
        const email = this.value.trim();
        if (!email) {
            this.classList.add('is-invalid');
            this.nextElementSibling.nextElementSibling.textContent = 'E-mail é obrigatório';
        } else if (!isValidEmail(email)) {
            this.classList.add('is-invalid');
            this.nextElementSibling.nextElementSibling.textContent = 'Digite um e-mail válido';
        } else {
            this.classList.remove('is-invalid');
            this.nextElementSibling.nextElementSibling.textContent = '';
        }
    });
    
    // Validar nome
    nomeInput.addEventListener('blur', function() {
        const nome = this.value.trim();
        if (!nome) {
            this.classList.add('is-invalid');
            this.nextElementSibling.nextElementSibling.textContent = 'Nome completo é obrigatório';
        } else if (nome.length < 2) {
            this.classList.add('is-invalid');
            this.nextElementSibling.nextElementSibling.textContent = 'Nome deve ter pelo menos 2 caracteres';
        } else {
            this.classList.remove('is-invalid');
            this.nextElementSibling.nextElementSibling.textContent = '';
        }
    });
    
    // Validar senha (apenas se for novo usuário ou se foi preenchida)
    passwordInput.addEventListener('blur', function() {
        const password = this.value;
        {% if not usuario %}
        if (!password) {
            this.classList.add('is-invalid');
            this.nextElementSibling.nextElementSibling.textContent = 'Senha é obrigatória';
        } else if (password.length < 6) {
            this.classList.add('is-invalid');
            this.nextElementSibling.nextElementSibling.textContent = 'Senha deve ter pelo menos 6 caracteres';
        } else {
            this.classList.remove('is-invalid');
            this.nextElementSibling.nextElementSibling.textContent = '';
        }
        {% else %}
        if (password && password.length < 6) {
            this.classList.add('is-invalid');
            this.nextElementSibling.nextElementSibling.textContent = 'Senha deve ter pelo menos 6 caracteres';
        } else {
            this.classList.remove('is-invalid');
            this.nextElementSibling.nextElementSibling.textContent = '';
        }
        {% endif %}
    });
    
    // Validar perfil
    if (roleSelect) {
        roleSelect.addEventListener('change', function() {
            if (!this.value) {
                this.classList.add('is-invalid');
                this.nextElementSibling.nextElementSibling.textContent = 'Perfil é obrigatório';
            } else {
                this.classList.remove('is-invalid');
                this.nextElementSibling.nextElementSibling.textContent = '';
            }
        });
    }
    
    // Validação no submit
    form.addEventListener('submit', function(e) {
        let hasErrors = false;
        
        // Validar campos obrigatórios
        const username = usernameInput.value.trim();
        const email = emailInput.value.trim();
        const nome = nomeInput.value.trim();
        const password = passwordInput.value;
        const role = roleSelect ? roleSelect.value : '';
        
        // Validar username
        if (!username || !isValidUsername(username)) {
            usernameInput.classList.add('is-invalid');
            hasErrors = true;
        }
        
        // Validar email
        if (!email || !isValidEmail(email)) {
            emailInput.classList.add('is-invalid');
            hasErrors = true;
        }
        
        // Validar nome
        if (!nome || nome.length < 2) {
            nomeInput.classList.add('is-invalid');
            hasErrors = true;
        }
        
        // Validar senha
        {% if not usuario %}
        if (!password || password.length < 6) {
            passwordInput.classList.add('is-invalid');
            hasErrors = true;
        }
        {% else %}
        if (password && password.length < 6) {
            passwordInput.classList.add('is-invalid');
            hasErrors = true;
        }
        {% endif %}
        
        // Validar perfil
        if (roleSelect && !role) {
            roleSelect.classList.add('is-invalid');
            hasErrors = true;
        }
        
        if (hasErrors) {
            e.preventDefault();
            return false;
        }
        
        // Desabilitar botão para evitar double-submit
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Salvando...';
    });
});
</script>
{% endblock %} 